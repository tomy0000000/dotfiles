name: Test macOS features

on:
  push:
    branches:
      - main
    paths-ignore:
      - "docs/**"
      - "docs/**"
  pull_request:

jobs:
  generate-matrix:
    name: ğŸŒ€ Generate matrix
    runs-on: ubuntu-latest
    outputs:
      features: ${{ steps.merge-features.outputs.features }}
    steps:
      - name: ğŸ›’ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—‚ï¸ Get all features
        id: all-features
        run: .github/scripts/all-features.sh

      - name: ğŸ“„ List changed files
        id: changed-files
        run: .github/scripts/changed-files.sh '${{ toJson(github) }}'

      - name: ğŸ§® Generate feature list
        id: feature-list
        run: .github/scripts/feature-list.sh '${{ steps.changed-files.outputs.paths }}'

      - name: ğŸ“Š Generate affected feature list
        id: affected-list
        run: .github/scripts/affected-list.py '${{ steps.feature-list.outputs.features }}' '${{ steps.all-features.outputs.features }}'

      - name: ğŸ”€ Merge with fixed features
        id: merge-features
        run: .github/scripts/merge-features.sh '${{ steps.affected-list.outputs.features }}'

  macos:
    name: ğŸ–¥ï¸ macOS Test
    runs-on: macos-latest
    needs: generate-matrix
    strategy:
      fail-fast: false
      matrix:
        features: ${{ fromJson(needs.generate-matrix.outputs.features) }}
    steps:
      - name: ğŸ›’ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§ª Test "${{ matrix.features }}"
        run: make ${{ matrix.features }}
